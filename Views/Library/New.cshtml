@model PDFUpload.Models.ViewBookModel
@{
    ViewData["Title"] = "New";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>New</h1>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.8/css/select2.min.css" integrity="sha512-xrbX64SIXOxo5cMQEDUQ3UyKsCreOEq1Im90z3B7KPoxLJ2ol/tCT0aBhuIzASfmBVdODioUdUPbt5EDEXmD9g==" crossorigin="anonymous" />
<script src="~/Scripts/jquery-1.10.2.js"></script>
<script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>


@*<form asp-controller="Books" asp-action="createBook" data-ajax="true" data-ajax-method="POST" typeof="application/json;">
*@

@using (Html.BeginForm("Create", "Library", FormMethod.Post, new { enctype = "multipart/form-data", id = "myForm" }))
{

    <div class="form-group">
        @Html.LabelFor(m => m.Title)
        @Html.TextBoxFor(m => m.Title, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Title)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.Author)
        @Html.TextBoxFor(m => m.Author, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Author)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.Pages)
        @Html.TextBoxFor(m => m.Pages, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Pages)
    </div>

    <div>
        @*<input id="file" type="file">*@

        <input asp-for="BookFile" type="file">
        <input type="submit" value="Upload" id="submit" style="display: none;" />
    </div>
    <br />
    <br />
    <div class="form-group">
        <label>AddTags </label> <br />
        <select name="tags[]" multiple="multiple" id="tags" class="tags" style="width:300px;">
        </select> <br />
        <input id="new-car" type="text" />
        <button type="button" id="btn-add-car">Set state value</button>
    </div>

    <btn id="tagsButton" class="btn btn-primary">Stisni</btn>


}


@section scripts
{
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.8/js/select2.min.js" integrity="sha512-A5lKSoM6p2axvCtNMT5fvLyjuAavxGlfC1YU0Wn8NzWixwutPUCYfymJQLORJ4YFoKIEAqKCN8+MpQQwzi2bjg==" crossorigin="anonymous"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            var vmb = {
                //bookTags: []
            }
            var bookTags = [];
            var izbraniTagovi;
            //////////////// ne pipaj dole
            $('#tags').select2({
                ajax: {
                    //url: '/api/customers?query=%QUERY',
                    //  wildcard: '%QUERY'
                    url: '/api/books/allTags?',
                    dataType: "json", // mozda treba jsonP ama proveri
                    data: function (params) {
                        //zborovi = params.term; // input data
                        //console.log("ti vnese  :  " + zborovi) // console.log
                        return {
                            q: params.term // search term
                        };
                    },
                    processResults: function (data) {
                        var tagList;
                        tagList = [];
                        $.each(data, function (idx, item) {
                            tagList.push({
                                'id': item.id,
                                'text': item.tagName
                            });
                        });
                        return { results: tagList };
                    },
                }
            });


            /// Nov Tag
            $("#btn-add-car").on("click", function () {
                var newStateVal = $("#new-car").val();
                // Set the value, creating a new option if necessary
                if ($("#tags").find("option[value=" + newStateVal + "]").length) {
                    $("#tags").val(newStateVal).trigger("change");
                } else {
                    // Create the DOM option that is pre-selected by default
                    var newState = new Option(newStateVal, newStateVal, true, true);
                    // Append it to the select
                    $("#tags").append(newState).trigger('change');
                }
            });



            ///////// newBook !!!!!!!
            $("#tagsButton").click(function () {
                vmb.title = $("#title").val();
                vmb.pages = $("#pages").val();
                vmb.author = $("#author").val();
                izbraniTagovi = uniq_fast($('#tags').select2('data'));

                $.each(izbraniTagovi, function (idx, item) {
                    bookTags.push(
                        {
                            "id": item.id,
                            "tagName": item.text
                        }
                    );
                });
                console.log(bookTags);
                var sendBookTags = JSON.stringify(bookTags);
                $.ajax({
                    processData: false,
                    //contentType: false
                    contentType: "application/json; charset=utf-8",
                    type: "POST",
                    url: "/api/Books/newBookTags", // ovde sakam da pratam vm model od ViewBookModel
                    //dataType: "json",
                    data: JSON.stringify(bookTags),
                    success: function () {
                        $("#submit").click();
                    },
                    error: function (e) {
                        console.log(e);
                    },
                    //$("#submit").click;
                    //setTimeout(() => { $("#tagsButton").click; }, 400);
                });

            });

            // filter if duplicate (long code but best performance)
            function uniq_fast(a) {
                var seen = {};
                var out = [];
                var len = a.length;
                var j = 0;
                for (var i = 0; i < len; i++) {
                    var item = a[i];
                    if (seen[item] !== 1) {
                        seen[item] = 1;
                        out[j++] = item;
                    }
                }
                return out;
            }

            //// "U" for selected tagList
            $(window).keydown(function (event) { // U koga ke stisnes ke gi isprinta site IZBRANI tagovi
                if (event.keyCode == 85) {
                    izbraniTagovi = $('#tags').select2('data');
                    console.log("ti gi izbra slednive tagovi: ")
                    console.log(izbraniTagovi)
                }
            });


            //////// Enter disable
            $(window).keydown(function (event) { // za Enter da ne ja submitne formata
                if (event.keyCode == 13) {
                    event.preventDefault();
                    return false;
                }
            });



        });
    </script>
}
